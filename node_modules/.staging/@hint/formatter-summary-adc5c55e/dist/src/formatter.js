"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const chalk_1 = require("chalk");
const lodash_1 = require("lodash");
const table = require("text-table");
const logSymbols = require("log-symbols");
const debug_1 = require("hint/dist/src/lib/utils/debug");
const types_1 = require("hint/dist/src/lib/types");
const logger = require("hint/dist/src/lib/utils/logging");
const _ = {
    defaultTo: lodash_1.defaultTo,
    forEach: lodash_1.forEach,
    groupBy: lodash_1.groupBy
};
const debug = debug_1.debug(__filename);
class SummaryFormatter {
    format(messages) {
        debug('Formatting results');
        if (_.defaultTo(messages.length, 0) === 0) {
            return;
        }
        const buildMessage = (count, type) => {
            if (count === 0) {
                return '';
            }
            return `${count} ${type}${count === 1 ? '' : 's'}`;
        };
        const tableData = [];
        let totalErrors = 0;
        let totalWarnings = 0;
        const resources = _.groupBy(messages, 'hintId');
        const sortedResources = Object.entries(resources).sort(([hintA, problemsA], [hintB, problemsB]) => {
            if (problemsA.length < problemsB.length) {
                return -1;
            }
            if (problemsA.length > problemsB.length) {
                return 1;
            }
            return hintA.localeCompare(hintB);
        });
        _.forEach(sortedResources, ([hintId, problems]) => {
            const msgsBySeverity = _.groupBy(problems, 'severity');
            const errors = msgsBySeverity[types_1.Severity.error] ? msgsBySeverity[types_1.Severity.error].length : 0;
            const warnings = msgsBySeverity[types_1.Severity.warning] ? msgsBySeverity[types_1.Severity.warning].length : 0;
            const red = chalk_1.default.red;
            const yellow = chalk_1.default.yellow;
            const line = [chalk_1.default.cyan(hintId)];
            if (errors > 0) {
                line.push(red(buildMessage(errors, 'error')));
            }
            if (warnings > 0) {
                line.push(yellow(buildMessage(warnings, 'warning')));
            }
            tableData.push(line);
            totalErrors += errors;
            totalWarnings += warnings;
        });
        logger.log(table(tableData));
        const color = totalErrors > 0 ? chalk_1.default.red : chalk_1.default.yellow;
        logger.log(color.bold(`${logSymbols.error} Found a total of ${totalErrors} ${totalErrors === 1 ? 'error' : 'errors'} and ${totalWarnings} ${totalWarnings === 1 ? 'warning' : 'warnings'}`));
    }
}
exports.default = SummaryFormatter;
